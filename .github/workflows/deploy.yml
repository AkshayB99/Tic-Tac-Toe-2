name: Deploy to EC2 via SSH

on:
  push:
    branches: [main]   # change if your branch is different

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code   # optional, but useful if you want to pass files later
        uses: actions/checkout@v4

      - name: Deploy via SSH (git pull + docker build + run)
        uses: appleboy/ssh-action@v1.0.3   # latest stable
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}   # e.g. ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}         # full private key content (the one for SSH login to EC2)
          port: 22
          script: |                               # multi-line script runs on EC2
            cd ~/projects/tic-tac-toe             # ‚Üê adjust to your actual path!
            
            # Optional: force clean pull (removes local changes)
            git fetch --all
            git reset --hard origin/main
            git pull origin main
            
            # Build new image
            docker build -t tic-tac-toe:latest .
            
            # Optional: clean old dangling images/layers
            docker image prune -f
            
            # Restart container (zero-downtime-ish for small apps)
            docker stop tic-tac-toe || true
            docker rm tic-tac-toe || true
            docker run -d \
              --name tic-tac-toe \
              --restart unless-stopped \
              -p 80:80 \
              tic-tac-toe:latest
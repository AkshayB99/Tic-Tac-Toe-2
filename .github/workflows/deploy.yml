name: Deploy to EC2 via SSH

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy via SSH (git pull + docker build + run)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          debug: true   # helps with troubleshooting
          script: |
            # Navigate to project (create if missing)
            if [ ! -d "~/projects/tic-tac-toe" ]; then
              mkdir -p ~/projects
              cd ~/projects
              git clone https://github.com/AkshayB99/Tic-Tac-Toe-2.git tic-tac-toe
              cd tic-tac-toe
            else
              cd ~/projects/tic-tac-toe
            fi

            # Pull latest code (clean reset to avoid conflicts)
            git fetch --all
            git reset --hard origin/main
            git pull origin main

            # Build Docker image
            docker build -t tic-tac-toe:latest .

            # Clean up old images
            docker image prune -f

            # Restart container
            docker stop tic-tac-toe || true
            docker rm tic-tac-toe || true
            docker run -d \
              --name tic-tac-toe \
              --restart unless-stopped \
              -p 80:5173 \
              tic-tac-toe:latest

            # Optional: show status
            docker ps | grep tic-tac-toe